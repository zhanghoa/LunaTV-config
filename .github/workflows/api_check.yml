name: API Check

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹è¿è¡Œ (UTC 17ç‚¹)
    - cron: "0 17 * * *"
  push:
    paths:
      # ç›‘å¬ LunaTV-config.json æ–‡ä»¶å˜æ›´
      - LunaTV-config.json
  workflow_dispatch:
    # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      api_name:
        description: 'æœç´¢å…³é”®å­— (ç”¨äº API æœç´¢åŠŸèƒ½æ£€æµ‹)'
        required: false
        default: 'ä½ å¥½' # é»˜è®¤æœç´¢å…³é”®å­—

jobs:
  check_apis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: å®‰è£…ä¾èµ–
        # å‡è®¾æ‰€æœ‰è„šæœ¬éƒ½ä¾èµ– axios
        run: npm install axios

      - name: è¿è¡Œ API æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆè„šæœ¬ (check_api.js)
        # è¿è¡Œä¸»æ£€æŸ¥è„šæœ¬ï¼Œç”Ÿæˆ report.md
        run: |
          API_NAME="${{ github.event.inputs.api_name || 'ä½ å¥½' }}"
          echo "æ£€æŸ¥ API: $API_NAME"
          # ç¡®ä¿è¿™ä¸ªæ–‡ä»¶åä¸æ‚¨ä»“åº“ä¸­çš„å®é™…æ–‡ä»¶åä¸€è‡´
          node check_api.js "$API_NAME" 

      - name: è¿è¡Œ TVBox é…ç½®è½¬æ¢è„šæœ¬ (generate_tvbox_config.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ tvbox-config-healthy.json
        run: node generate_tvbox_config.js

      - name: è¿è¡Œ README æ›´æ–°è„šæœ¬ (update_readme.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ README.md
        run: node update_readme.js

      - name: æäº¤å¹¶æ¨é€æŠ¥å‘Š (å½“å‰ä»“åº“)
        # æ¨é€ report.md å’Œ README.md åˆ°å½“å‰ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ä»…æ·»åŠ å½“å‰ä»“åº“éœ€è¦çš„æ–‡ä»¶
          git add report.md README.md
          git commit -m "æ›´æ–° API æŠ¥å‘Šå’Œ README ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
      - name: ğŸš€ æ¨é€ TVBox é…ç½®åˆ°ç›®æ ‡ç§æœ‰ä»“åº“ (Git Shell)
        run: |
          # 1. è®¾ç½® Git èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. ä½¿ç”¨ PAT è¿›è¡Œè®¤è¯å…‹éš†ï¼šå…³é”®æ­¥éª¤ï¼Œè§£å†³ "Repository not found"
          # æ ¼å¼ï¼šhttps://x-access-token:YOUR_PAT@github.com/user/repo.git
          git clone https://x-access-token:${{ secrets.PUSH_TO_OTHER_REPO }}@github.com/zhanghoa/config.git target_repo
          
          cd target_repo
          
          # 3. å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶
          # å°†æºæ–‡ä»¶ tvbox-config-healthy.json å¤åˆ¶åˆ°ç›®æ ‡è·¯å¾„ config/ï¼Œå¹¶é‡å‘½åä¸º tvbox.txt
          cp ../tvbox-config-healthy.json tvbox.txt
          
          # 4. æäº¤æ›´æ”¹
          git add tvbox.txt
          git commit -m "è‡ªåŠ¨æ›´æ–° TVBox å¥åº·é…ç½® [Action Run ID: ${{ github.run_id }}]" || echo "No changes to commit"
          
          # 5. æ¨é€ï¼ˆPushï¼‰åˆ°ç›®æ ‡ä»“åº“
          git push
          
      - name: åˆ é™¤è¿‡æœŸå·¥ä½œæµè®°å½•
        # æ¸…ç†å·¥ä½œæµè¿è¡Œå†å²
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
