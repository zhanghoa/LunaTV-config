# .github/workflows/api-check-and-update.yml

name: ğŸ“Š API Check, Build & Deploy

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      api_name:
        description: 'ç”¨äº API æœç´¢åŠŸèƒ½æ£€æµ‹çš„å…³é”®å­—'
        required: false
        default: 'ä½ å¥½'

  # 2. å®šæ—¶è§¦å‘ (æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹ / UTC 17ç‚¹)
  schedule:
    - cron: "0 17 * * *"
    
  # 3. æ–‡ä»¶å˜æ›´æ—¶è§¦å‘
  push:
    paths:
      - 'LunaTV-config.json' # æ³¨æ„è¿™é‡Œä½¿ç”¨å¼•å·ï¼Œæ˜¯æ›´å¥½çš„ YAML è¯­æ³•

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # èµ‹äºˆå·¥ä½œæµå‘ä»“åº“å†™å…¥å†…å®¹çš„æƒé™
    permissions:
      contents: write

    steps:
      # --- 1. ç¯å¢ƒå‡†å¤‡ ---
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4 # å‡çº§åˆ° v4

      - name: âš™ï¸ Setup Node.js Environment
        uses: actions/setup-node@v4 # å‡çº§åˆ° v4
        with:
          node-version: "20"
          cache: 'npm' # å¢åŠ  npm ç¼“å­˜ï¼ŒåŠ å¿«åç»­è¿è¡Œé€Ÿåº¦

      - name: ğŸ“¦ Install Dependencies
        run: npm ci # ä½¿ç”¨ npm ciï¼Œå®ƒæ¯” install æ›´å¿«ã€æ›´ä¸¥æ ¼ï¼Œé€‚åˆè‡ªåŠ¨åŒ–ç¯å¢ƒ

      # --- 2. æ ¸å¿ƒè„šæœ¬æ‰§è¡Œ ---
      - name: ğŸ”¬ Run API Check & Report Generation
        env:
          DATA_DIR_ENV: . # ç¯å¢ƒå˜é‡ä¿æŒä¸å˜
        run: |
          # ä½¿ç”¨ä¸‰å…ƒè¡¨è¾¾å¼æ–¹å¼ï¼Œæ›´ç®€æ´åœ°å¤„ç†é»˜è®¤å€¼
          KEYWORD="${{ github.event.inputs.api_name || 'ä½ å¥½' }}"
          echo "ğŸš€ Starting API check with keyword: $KEYWORD"
          node check_api.js "$KEYWORD"

      - name: ğŸ”„ Run TVBox Config Conversion
        env:
          DATA_DIR_ENV: .
        run: node generate_tvbox_config.js

      - name: ğŸ“ Run README Update
        env:
          DATA_DIR_ENV: .
        run: node update_readme.js

      # --- 3. éƒ¨ç½²åˆ°å½“å‰ä»“åº“ ---
      - name: â¬†ï¸ Commit and Push to This Repository
        uses: stefanzweifel/git-auto-commit-action@v5 # ä½¿ç”¨ä¸“ä¸šçš„è‡ªåŠ¨æäº¤ Action
        with:
          commit_message: "docs(auto): ğŸ“Š æ›´æ–° API æŠ¥å‘Šã€é…ç½®å’Œ README"
          commit_options: '--no-verify'
          # å®šä¹‰éœ€è¦æäº¤çš„æ–‡ä»¶æ¨¡å¼
          file_pattern: 'report.md README.md tvbox-healthy.json tvbox-full.json'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

      # --- 4. éƒ¨ç½²åˆ°ç§æœ‰ä»“åº“ ---
      - name: ğŸš€ Deploy TVBox Config to Private Repository
        run: |
          set -e # æ·»åŠ è¿™ä¸ªå‘½ä»¤ï¼Œå¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œè„šæœ¬å°†ç«‹å³é€€å‡º

          echo "ğŸšš Starting deployment to private repository..."
          
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone https://x-access-token:${{ secrets.PUSH_TO_OTHER_REPO }}@github.com/zhanghoa/config.git target_repo
          
          # å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶
          echo "Copying config files..."
          cp ./tvbox-healthy.json ./target_repo/tvbox.txt
          # cp ./tvbox-full.json ./target_repo/tvbox-full.txt # å¦‚éœ€æ¨é€å®Œæ•´ç‰ˆï¼Œå–æ¶ˆæ­¤è¡Œæ³¨é‡Š

          cd target_repo
          
          # å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œåˆ™ä¸æ‰§è¡Œæäº¤
          if [[ -z $(git status -s) ]]; then
            echo "No changes in target repository. Skipping commit."
          else
            echo "Changes detected. Committing and pushing..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "feat(auto): âœ¨ è‡ªåŠ¨æ›´æ–° TVBox å¥åº·é…ç½® [from run ${{ github.run_id }}]"
            git push
          fi
          
      # --- 5. æ¸…ç†å·¥ä½œæµè®°å½• ---
      - name: ğŸ§¹ Clean up old workflow runs
        uses: Mattraks/delete-workflow-runs@v2 # é”å®šåˆ° v2 ç‰ˆæœ¬
        with:
          retain_days: 1
          keep_minimum_runs: 5

