name: API Check

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹è¿è¡Œ (UTC 17ç‚¹)
    - cron: "0 17 * * *"
  push:
    paths:
      # ç›‘å¬ LunaTV-config.json æ–‡ä»¶å˜æ›´
      - LunaTV-config.json
  workflow_dispatch:
    # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      api_name:
        description: 'æœç´¢å…³é”®å­— (ç”¨äº API æœç´¢åŠŸèƒ½æ£€æµ‹)'
        required: false
        default: 'ä½ å¥½' # é»˜è®¤æœç´¢å…³é”®å­—

jobs:
  check_apis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: å®‰è£…ä¾èµ–
        # å‡è®¾æ‰€æœ‰è„šæœ¬éƒ½ä¾èµ– axios
        run: npm install axios

      - name: è¿è¡Œ API æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆè„šæœ¬ (check_api.js)
        # ğŸš¨ å…³é”®ä¿®æ”¹ 1ï¼šæ·»åŠ ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶è„šæœ¬åœ¨æ ¹ç›®å½•è¿è¡Œ
        env:
          DATA_DIR_ENV: .
        run: |
          API_NAME="${{ github.event.inputs.api_name || 'ä½ å¥½' }}"
          echo "æ£€æŸ¥ API: $API_NAME"
          node check_api.js "$API_NAME" 

      - name: è¿è¡Œ TVBox é…ç½®è½¬æ¢è„šæœ¬ (generate_tvbox_config.js)
        # ğŸš¨ å…³é”®ä¿®æ”¹ 1ï¼šæ·»åŠ ç¯å¢ƒå˜é‡
        env:
          DATA_DIR_ENV: .
        run: node generate_tvbox_config.js

      - name: è¿è¡Œ README æ›´æ–°è„šæœ¬ (update_readme.js)
        # ğŸš¨ å…³é”®ä¿®æ”¹ 1ï¼šæ·»åŠ ç¯å¢ƒå˜é‡
        env:
          DATA_DIR_ENV: .
        run: node update_readme.js

      - name: æäº¤å¹¶æ¨é€æŠ¥å‘Š (å½“å‰ä»“åº“)
        # æ¨é€ report.md å’Œ README.md åˆ°å½“å‰ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ å…³é”®ä¿®æ”¹ 2ï¼šæ–‡ä»¶åæ›´æ–°
          # ä¸Šä¸€ç‰ˆè„šæœ¬ç”Ÿæˆçš„æ˜¯ tvbox-healthy.json å’Œ tvbox-full.json
          # æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªæ–°æ–‡ä»¶ä¹ŸåŠ å…¥ç‰ˆæœ¬æ§åˆ¶
          git add report.md README.md tvbox-healthy.json tvbox-full.json
          
          git commit -m "æ›´æ–° API æŠ¥å‘Šå’Œ README ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
      - name: ğŸš€ æ¨é€ TVBox é…ç½®åˆ°ç›®æ ‡ç§æœ‰ä»“åº“ (Git Shell)
        run: |
          # 1. è®¾ç½® Git èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 2. ä½¿ç”¨ PAT è¿›è¡Œè®¤è¯å…‹éš†
          git clone https://x-access-token:${{ secrets.PUSH_TO_OTHER_REPO }}@github.com/zhanghoa/config.git target_repo
          
          cd target_repo
          
          # 3. å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶
          # ğŸš¨ å…³é”®ä¿®æ”¹ 3ï¼šæºæ–‡ä»¶åå˜æ›´ä¸º tvbox-healthy.json
          # å°† çº¯å‡€ç‰ˆé…ç½® å¤åˆ¶ä¸º tvbox.txt
          cp ../tvbox-healthy.json tvbox.txt
          
          # (å¯é€‰) å¦‚æœæ‚¨æƒ³æŠŠå®Œæ•´ç‰ˆä¹Ÿæ¨è¿‡å»ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š
          # cp ../tvbox-full.json tvbox-full.txt
          
          # 4. æäº¤æ›´æ”¹
          git add tvbox.txt
          # git add tvbox-full.txt
          
          git commit -m "è‡ªåŠ¨æ›´æ–° TVBox å¥åº·é…ç½® [Action Run ID: ${{ github.run_id }}]" || echo "No changes to commit"
          
          # 5. æ¨é€ï¼ˆPushï¼‰åˆ°ç›®æ ‡ä»“åº“
          git push
          
      - name: åˆ é™¤è¿‡æœŸå·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
