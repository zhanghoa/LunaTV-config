name: API Check

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹è¿è¡Œ (UTC 17ç‚¹)
    - cron: "0 17 * * *"
  push:
    paths:
      # ç›‘å¬ LunaTV-config.json æ–‡ä»¶å˜æ›´
      - LunaTV-config.json
  workflow_dispatch:
    # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      api_name:
        description: 'æœç´¢å…³é”®å­— (ç”¨äº API æœç´¢åŠŸèƒ½æ£€æµ‹)'
        required: false
        default: 'ä½ å¥½' # é»˜è®¤æœç´¢å…³é”®å­—

jobs:
  check_apis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: å®‰è£…ä¾èµ–
        # å‡è®¾æ‰€æœ‰è„šæœ¬éƒ½ä¾èµ– axios
        run: npm install axios

      - name: è¿è¡Œ API æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆè„šæœ¬ (check_api.js)
        # è¿è¡Œä¸»æ£€æŸ¥è„šæœ¬ï¼Œç”Ÿæˆ report.md
        run: |
          API_NAME="${{ github.event.inputs.api_name || 'ä½ å¥½' }}"
          echo "æ£€æŸ¥ API: $API_NAME"
          # ç¡®ä¿è¿™ä¸ªæ–‡ä»¶åä¸æ‚¨ä»“åº“ä¸­çš„å®é™…æ–‡ä»¶åä¸€è‡´
          node check_api.js "$API_NAME" 

      - name: è¿è¡Œ TVBox é…ç½®è½¬æ¢è„šæœ¬ (generate_tvbox_config.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ tvbox-config-healthy.json
        run: node generate_tvbox_config.js

      - name: è¿è¡Œ README æ›´æ–°è„šæœ¬ (update_readme.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ README.md
        run: node update_readme.js

      - name: æäº¤å¹¶æ¨é€æŠ¥å‘Š (å½“å‰ä»“åº“)
        # æ¨é€ report.md å’Œ README.md åˆ°å½“å‰ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # ä»…æ·»åŠ å½“å‰ä»“åº“éœ€è¦çš„æ–‡ä»¶
          git add report.md README.md
          git commit -m "æ›´æ–° API æŠ¥å‘Šå’Œ README ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
      - name: ğŸš€ æ¨é€ TVBox é…ç½®åˆ°ç›®æ ‡ä»“åº“ (zhanghoa/config)
        # ä½¿ç”¨ä¿®æ­£åçš„å‚æ•°åï¼Œå°† tvbox-config-healthy.json æ¨é€åˆ° zhanghoa/config
        uses: cpina/github-action-push-to-another-repository@main
        with:
          # ä½¿ç”¨ PAT ä½œä¸ºè®¤è¯ä»¤ç‰Œï¼Œç¡®ä¿å…¶æœ‰ repo æƒé™
          API_TOKEN_GITHUB: ${{ secrets.PUSH_TO_OTHER_REPO }}
          
          # ç›®æ ‡ä»“åº“è¯¦æƒ…
          destination-github-username: zhanghoa
          destination-repository-name: config
          
          # æºæ–‡ä»¶è·¯å¾„
          source-file: tvbox-config-healthy.json
          
          # ç›®æ ‡è·¯å¾„å’Œæ–‡ä»¶å
          target-directory: config
          destination-file: tvbox.txt
          
          # ç›®æ ‡åˆ†æ”¯
          target-branch: main
          
          # æäº¤ä¿¡æ¯
          commit-message: "è‡ªåŠ¨æ›´æ–° TVBox å¥åº·é…ç½® [Action Run ID: ${{ github.run_id }}]"
          user-email: github-actions[bot]@users.noreply.github.com
          user-name: github-actions[bot]
          
      - name: åˆ é™¤è¿‡æœŸå·¥ä½œæµè®°å½•
        # æ¸…ç†å·¥ä½œæµè¿è¡Œå†å²
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
