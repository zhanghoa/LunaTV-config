name: API Check

on:
  schedule:
    # 每天北京时间凌晨1点运行 (UTC 17点)
    - cron: "0 17 * * *"
  push:
    paths:
      # 监听 LunaTV-config.json 文件变更
      - LunaTV-config.json
  workflow_dispatch:
    # 添加手动触发
    inputs:
      api_name:
        description: '搜索关键字 (用于 API 搜索功能检测)'
        required: false
        default: '你好' # 默认搜索关键字

jobs:
  check_apis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: 安装依赖
        # 假设所有脚本都依赖 axios
        run: npm install axios

      - name: 运行 API 检查和报告生成脚本 (check_api.js)
        # 运行主检查脚本，生成 report.md
        run: |
          API_NAME="${{ github.event.inputs.api_name || '你好' }}"
          echo "检查 API: $API_NAME"
          node check_api.js "$API_NAME"

      - name: 运行 TVBox 配置转换脚本 (generate_tvbox_config.js)
        # 读取 report.md，生成 tvbox-config-healthy.json
        run: node generate_tvbox_config.js

      - name: 运行 README 更新脚本 (update_readme.js)
        # 读取 report.md，生成 README.md
        run: node update_readme.js

      - name: 提交并推送报告
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 添加所有生成的文件
          git add report.md README.md tvbox-config-healthy.json
          git commit -m "更新 API 健康报告、TVBox 配置及 README ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main
          
      - name: 删除过期工作流记录
        # 删除工作流记录/只保留1天记录，最少保留 5 次
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
