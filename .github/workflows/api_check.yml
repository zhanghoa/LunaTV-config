name: API Check

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨1ç‚¹è¿è¡Œ (UTC 17ç‚¹)
    - cron: "0 17 * * *"
  push:
    paths:
      # ç›‘å¬ LunaTV-config.json æ–‡ä»¶å˜æ›´
      - LunaTV-config.json
  workflow_dispatch:
    # æ·»åŠ æ‰‹åŠ¨è§¦å‘
    inputs:
      api_name:
        description: 'æœç´¢å…³é”®å­— (ç”¨äº API æœç´¢åŠŸèƒ½æ£€æµ‹)'
        required: false
        default: 'ä½ å¥½' # é»˜è®¤æœç´¢å…³é”®å­—

jobs:
  check_apis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: å®‰è£… Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: å®‰è£…ä¾èµ–
        # å‡è®¾æ‰€æœ‰è„šæœ¬éƒ½ä¾èµ– axios
        run: npm install axios

      - name: è¿è¡Œ API æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆè„šæœ¬ (check_api.js)
        # è¿è¡Œä¸»æ£€æŸ¥è„šæœ¬ï¼Œç”Ÿæˆ report.md
        run: |
          API_NAME="${{ github.event.inputs.api_name || 'ä½ å¥½' }}"
          echo "æ£€æŸ¥ API: $API_NAME"
          node check_api.js "$API_NAME"

      - name: è¿è¡Œ TVBox é…ç½®è½¬æ¢è„šæœ¬ (generate_tvbox_config.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ tvbox-config-healthy.json
        run: node generate_tvbox_config.js

      - name: è¿è¡Œ README æ›´æ–°è„šæœ¬ (update_readme.js)
        # è¯»å– report.mdï¼Œç”Ÿæˆ README.md
        run: node update_readme.js

      - name: æäº¤å¹¶æ¨é€æŠ¥å‘Š
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ·»åŠ æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          git add report.md README.md tvbox-config-healthy.json
          git commit -m "æ›´æ–° API å¥åº·æŠ¥å‘Šã€TVBox é…ç½®åŠ README ($(date -d '+8 hour' +'%Y-%m-%d %H:%M:%S CST'))" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

      - name: ğŸš€ æ¨é€ TVBox é…ç½®åˆ°ç›®æ ‡ä»“åº“ (zhanghoa/config)
        uses: cpina/github-action-push-to-another-repository@main
        with:
          # ä½¿ç”¨æ­¥éª¤ä¸€ä¸­åˆ›å»ºçš„ Secret
          github_token: ${{ secrets.PUSH_TO_OTHER_REPO }}
          
          # æºæ–‡ä»¶è·¯å¾„ï¼šå½“å‰ä»“åº“ä¸­ç”Ÿæˆçš„ TVBox é…ç½®
          source_file: tvbox-config-healthy.json
          
          # ç›®æ ‡ä»“åº“ï¼šzhanghoa/config
          destination_repo: zhanghoa/config
          
          # ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼šconfig/tvbox.txt
          destination_folder: config
          destination_file: tvbox.txt
          
          # ç›®æ ‡åˆ†æ”¯
          destination_branch: main
          
          # æäº¤ä¿¡æ¯
          commit_message: "è‡ªåŠ¨æ›´æ–° TVBox å¥åº·é…ç½® [Action Run ID: ${{ github.run_id }}]"
          
          # æäº¤è€…ä¿¡æ¯
          user_email: github-actions[bot]@users.noreply.github.com
          user_name: github-actions[bot]
          
      - name: åˆ é™¤è¿‡æœŸå·¥ä½œæµè®°å½•
        # åˆ é™¤å·¥ä½œæµè®°å½•/åªä¿ç•™1å¤©è®°å½•ï¼Œæœ€å°‘ä¿ç•™ 5 æ¬¡
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 5
