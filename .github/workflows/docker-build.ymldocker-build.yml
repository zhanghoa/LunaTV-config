# =========================================================
# Stage 1: 构建阶段
# =========================================================
FROM node:20-alpine AS builder
RUN apk update && apk add --no-cache dos2unix
WORKDIR /usr/src/app
COPY package*.json ./
RUN npm install --production
RUN npm cache clean --force

# 复制文件 (注意：确保文件名与您本地一致)
COPY check_api.js generate_tvbox_config.js update_readme.js server.js ./
COPY LunaTV-config.json ./
COPY README.md ./

# 修复换行符
RUN dos2unix check_api.js generate_tvbox_config.js update_readme.js server.js

# =========================================================
# Stage 2: 运行阶段
# =========================================================
FROM node:20-alpine
WORKDIR /app

# 复制依赖
COPY --from=builder /usr/src/app/node_modules ./node_modules

# 复制脚本
COPY --from=builder /usr/src/app/*.js ./

# 创建数据目录
RUN mkdir -p /app/data

# 复制默认配置到数据目录（作为初始模板）
COPY --from=builder /usr/src/app/LunaTV-config.json /app/data/
COPY --from=builder /usr/src/app/README.md /app/data/

EXPOSE 8080
ENTRYPOINT ["node"]
CMD ["server.js"]
